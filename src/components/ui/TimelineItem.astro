---
import { cn } from "@/lib/utils";
import { TechLabel } from "./TechLabel";

interface Props {
  title: string;
  company: string;
  location: string;
  date: string;
  description?: string;
  techStack?: string[];
  color?: "emerald" | "blue";
  class?: string;
}

const {
  title,
  company,
  location,
  date,
  description,
  techStack,
  color = "emerald",
  class: className,
} = Astro.props;

const colorStyles = {
  emerald: {
    dotBg: "bg-emerald-500",
    dotText: "text-emerald-500",
    dateText: "text-emerald-400",
  },
  blue: {
    dotBg: "bg-blue-500",
    dotText: "text-blue-500",
    dateText: "text-blue-400",
  },
};

const styles = colorStyles[color];
---

<div class={cn("relative pl-6 py-2 md:pl-12 group", className)}>
  <span
    class={cn(
      "relative block mb-1 text-sm font-mono font-bold whitespace-nowrap capitalize sm:absolute top-2 md:top-4 sm:mb-0",
      "sm:right-0 sm:left-auto sm:translate-x-0 lg:right-auto lg:-left-6 lg:-translate-x-full",
      styles.dateText,
    )}
  >
    {date}
  </span>
  {/* Dot on Line */}
  <div
    class={cn(
      "absolute -left-3 top-4 w-5 h-5 rounded-full border-4 border-gray-900 group-hover:scale-125 transition-transform duration-300 shadow-[0_0_10px_currentColor]",
      styles.dotBg,
      styles.dotText,
    )}
  >
  </div>

  <div
    class="flex flex-col justify-between sm:flex-row sm:items-baseline gap-2 mb-1"
  >
    <h3 class="text-base sm:text-lg md:text-xl font-bold text-white">
      {title}
    </h3>
  </div>
  <div class="text-sm sm:text-base lg:text-lg text-gray-300 font-medium mb-2">
    {company}
    <span class="text-gray-500 text-xs md:text-sm">â€¢ {location}</span>
  </div>
  {
    description && (
      <div class="description-container relative">
        <p class="text-gray-400 text-xs sm:text-sm md:max-w-2xl leading-relaxed line-clamp-2 md:line-clamp-none transition-all duration-300">
          {description}
        </p>
        <button class="read-more-btn text-emerald-400 text-xs font-medium mt-1 hover:text-emerald-300 md:hidden hidden">
          Read more
        </button>
      </div>
    )
  }

  <script>
    document.addEventListener("astro:page-load", () => {
      initReadMore();
    });

    // Initial load in case view transitions aren't used or for first load
    initReadMore();

    function initReadMore() {
      const containers = document.querySelectorAll(".description-container");

      containers.forEach((container) => {
        const p = container.querySelector("p");
        const btn = container.querySelector(".read-more-btn");

        if (!p || !btn) return;

        // Check if text is actually clamped
        // We compare scrollHeight with clientHeight
        // Note: this check might need a slight delay if fonts are loading,
        // but typically safe enough here or strictly relying on valid overflow logic

        const isOverflowing = p.scrollHeight > p.clientHeight;

        if (isOverflowing) {
          btn.classList.remove("hidden");
        }

        if (btn.hasAttribute("data-has-listener")) return;
        btn.setAttribute("data-has-listener", "true");

        btn.addEventListener("click", () => {
          if (p.classList.contains("line-clamp-2")) {
            p.classList.remove("line-clamp-2");
            btn.textContent = "Show less";
          } else {
            p.classList.add("line-clamp-2");
            btn.textContent = "Read more";
          }
        });
      });
    }
  </script>

  {/* Tech Stack Badge */}
  {
    techStack && techStack.length > 0 && (
      <div class="mt-3 flex flex-wrap gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
        {techStack.map((tech) => (
          <TechLabel name={tech} className="px-2 py-0.5 text-xs" />
        ))}
      </div>
    )
  }
</div>
