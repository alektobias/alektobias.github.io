---
import fs from "node:fs/promises";
import path from "node:path";
import { WordRotate } from "../ui/word-rotate";
import { AuroraText } from "../ui/aurora-text";
import Contact from "./Contact.astro";
import skills from "@data/techskills.json";
import contact from "@data/contact.json";
import TechCarousel from "./TechCarousel.astro";
import HighlightStats from "./HighlightStats.astro";
import { TechIconCloud } from "./TechIconCloud";
import SmokeBackground from "./SmokeBackground";
import { ArrowDown } from "lucide-react";
import { loadUiData } from "../../utils/loadData";

interface Props {
  lang?: string;
}

const { lang = "en" } = Astro.props;

// Load UI Data
const ui = await loadUiData(lang);

// Load Profile Data Dynamically
const profilePath = path.join(process.cwd(), `docs/data/${lang}/profile.json`);
const profileContent = await fs.readFile(profilePath, "utf-8");
const profile = JSON.parse(profileContent);

// Load Experiences Data Dynamically
const experiencesPath = path.join(
  process.cwd(),
  `docs/data/${lang}/experiences.json`,
);
const experiencesContent = await fs.readFile(experiencesPath, "utf-8");
const experiences = JSON.parse(experiencesContent);

const { name, title } = profile;

// Flatten all skills into a single array for the icon cloud
const allSkills = [
  ...skills.runtime,
  ...skills.frontend,
  ...skills.backend,
  ...skills.databases,
  ...skills.devops,
  ...skills.tools,
];
---

<section
  class="min-h-dvh md:h-screen relative overflow-x-clip md:overflow-y-hidden bg-gray-950 text-white"
>
  {/* Background Elements */}
  {/* Smoke Background Effect */}
  <SmokeBackground client:only="react" />

  <div class="container z-20 relative h-dvh md:h-screen">
    <div
      class="grid grid-cols-1 md:grid-cols-2 h-full relative overflow-visible"
    >
      <div
        class="md:space-y-8 self-center md:col-span-1 z-30 md:relative pt-12 pb-24 md:pt-0 h-min bottom-0 absolute w-full"
      >
        {/* Mobile Contrast Backdrop */}
        <div
          class="absolute inset-0 -z-10 bg-linear-to-t from-black/80 via-black/40 to-transparent blur-xl md:hidden transform -translate-y-12 h-[120%]"
        >
        </div>
        <div
          class="animate-on-scroll opacity-0 translate-y-8 transition-all duration-700 ease-out"
        >
          <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-4">
            {ui?.hero?.greeting}
            <br />
            <AuroraText
              className="text-5xl md:text-7xl font-bold tracking-tight"
              colors={["#34d399", "#10b981", "#064e3b"]}
            >
              {name}
            </AuroraText>
          </h1>
          <div
            class="h-12 flex items-center text-2xl md:text-3xl font-light text-gray-300"
          >
            <WordRotate words={title} client:load className=" font-semibold" />
          </div>
        </div>

        <div
          class="animate-on-scroll opacity-0 translate-y-8 transition-all duration-700 ease-out"
          style="transition-delay: 200ms"
        >
          <Contact
            contact={contact}
            profile={profile}
            experiences={experiences}
            skills={skills}
            ui={ui}
          />
        </div>

        <!-- <TechCarousel /> -->
      </div>

      <div
        class="relative inset-x-0 bottom-0 h-full md:relative md:h-full flex items-end justify-center md:justify-end pointer-events-none md:col-span-1 overflow-visible"
      >
        {/* 3D Floating Tech Icon Cloud - BACK LAYER */}
        <div
          class="animate-on-scroll opacity-0 transition-opacity duration-1000 ease-out absolute inset-0 w-full h-full z-0"
          style="transition-delay: 400ms"
        >
          <TechIconCloud
            skills={allSkills}
            displayLayer="behind-only"
            client:load
          />
        </div>

        {/* 3D Floating Tech Icon Cloud - FRONT LAYER */}
        <div
          class="animate-on-scroll opacity-0 transition-opacity duration-1000 ease-out absolute inset-0 w-full h-full z-20 pointer-events-none"
          style="transition-delay: 400ms"
        >
          <TechIconCloud
            skills={allSkills}
            displayLayer="front-only"
            client:load
          />
        </div>

        <div
          class="absolute bottom-0 w-full h-[88vh] z-10 overflow-visible flex justify-center md:block"
        >
          <div
            class="w-full h-full animate-on-scroll opacity-0 translate-y-8 transition-all duration-1000 ease-out z-10"
            style="transition-delay: 300ms"
          >
            <img
              src="/assets/profile-hero.png"
              alt={name}
              class="h-full w-auto object-cover mx-auto drop-shadow-2xl mask-[linear-gradient(to_top,black_90%,transparent_100%)] md:mask-[linear-gradient(93deg,black_50%,transparent_95%)]"
            />
          </div>
        </div>
      </div>
      <div
        class="hidden md:block absolute bottom-[15vh] left-0 w-full z-20 overflow-hidden py-4 pointer-events-auto"
      >
        <HighlightStats stats={ui.hero.stats} id="desktop-stats" />
      </div>
    </div>
  </div>
  {/* Scroll Indicator */}
  <div
    class="absolute bottom-12 md:bottom-10 left-0 right-0 z-30 flex flex-col items-center gap-2 pointer-events-none animate-on-scroll opacity-0 translate-y-8 transition-all duration-700 ease-out"
    style="transition-delay: 800ms"
  >
    <div class="opacity-70 transition-opacity">
      <span
        class="text-xs text-gray-400 uppercase tracking-widest font-mono cursor-pointer hover:opacity-100 pointer-events-auto"
        >{ui.hero.scrollIndicator}</span
      >
    </div>
  </div>
  {/* Mobile Highlights Section (Vertical Stack) */}
</section>
<div
  class="flex flex-col items-center justify-center md:hidden bg-gray-950 py-12 relative z-30 px-4"
>
  <HighlightStats stats={ui.hero.stats} id="mobile-stats" />
</div>

<script>
  const observerOptions = {
    root: null,
    rootMargin: "0px",
    threshold: 0.1,
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.remove("opacity-0", "translate-y-8");
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  document.querySelectorAll(".animate-on-scroll").forEach((item) => {
    observer.observe(item);
  });
</script>
